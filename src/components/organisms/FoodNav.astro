---
import FoodIcon from "../atoms/icons/FoodIcon.astro";

const categories: string[] = Astro.props.categories ?? [];
// Map display/type names to FoodIcon keys
const iconMap: Record<string, string> = {
  Nem: "nem",
  Bobun: "bobun",
  Sandwich: "sandwich",
  "Sandwich Banh Mi": "sandwich",
  Burger: "burger",
  "Burger Banh Mi": "burger",
  "Plat principal": "plat",
  "Menu enfant": "kid",
  "Menu Enfant": "kid",
  Dessert: "dessert",
  Accompagnement: "side",
  Boisson: "boisson",
};
---

<nav class="food-nav">
  <div class="food-tags">
    <ul>
      {
        categories.map((cat: string) => {
          const iconSlug =
            iconMap[cat] ?? cat.toLowerCase().replace(/\s+/g, "");
          return (
            <li>
              <a
                class="food-link"
                href={`#${cat.toLowerCase().replace(/\s+/g, "-")}`}
              >
                <FoodIcon icon={iconSlug} ariaLabel={cat} />
                {cat}
              </a>
            </li>
          );
        })
      }
    </ul>
  </div>
</nav>
<style>
  .food-nav {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;

    padding: 0rem;
    position: sticky;
    top: 0;
    z-index: 1000;

    background: rgba(255, 255, 255, 0.25);
    backdrop-filter: blur(16px) saturate(180%);
    -webkit-backdrop-filter: blur(16px) saturate(180%);
    box-shadow:
      0 -2px 16px 0 rgba(0, 0, 0, 0.1),
      inset 0 1px 8px 0 rgba(255, 255, 255, 0.1);
  }

  .food-tags ul {
    display: flex;
    flex-direction: row;
    align-items: center;
    flex-wrap: wrap;
    gap: 0.5rem;
    padding: 1rem;
    justify-content: center;
  }

  .food-link {
    display: flex;
    align-items: center;
    width: fit-content;
    gap: 0.8rem;
    flex-direction: row;
    justify-content: center;
    border-radius: .5rem;
    padding: 0.5rem 1.3rem;

    text-decoration: none;
    white-space: nowrap;

    color: var(--secondary-700);
    background-color: var(--primary-500);
  }

  .food-link.active {
    background-color: var(--secondary-500);
    color: var(--primary-500);
  }

  .food-link:hover {
   background-color: var(--secondary-500);
    color: var(--primary-500);
  }

.food-link:focus-visible, a.food-link:focus-visible {
    outline: 2px solid var(--secondary-500) ;
    outline-offset: 2px ;
  }

  .food-link svg {
    min-width: 1.5rem;
    min-height: 1.5rem;
  }

  @media screen and (max-width: 768px) {
    .food-nav {
      overflow: hidden;
      width: 100vw;
      z-index: 1000;
      margin: 0;
      padding: .5rem 0 .5rem 0;
    }

    .food-tags.narrow {
      all: unset;
    }

    .food-tags ul {
      width: 100vw;
      display: flex;
      justify-content: flex-start;
      flex-wrap: nowrap;
      overflow-x: auto;
      overflow-y: hidden;
      gap: 1rem;
      padding: 0 1rem;
      margin: 0;
          scroll-behavior: smooth;

    }

    .food-tags ul::-webkit-scrollbar {
      display: none;
    }
  }
</style>

<script>

// Efficient scroll spy using requestAnimationFrame
let ticking = false;


const sections = Array.from(document.querySelectorAll("section[id]"));
let lastActiveId = null;

function centerActiveLink(link) {
  const ul = link.closest("ul");
  if (ul && window.innerWidth <= 768) {
    const ulRect = ul.getBoundingClientRect();
    const linkRect = link.getBoundingClientRect();
    const scrollLeft = ul.scrollLeft + (linkRect.left + linkRect.width / 2) - (ulRect.left + ulRect.width / 2);
    ul.scrollTo({ left: scrollLeft });
    if (typeof ul.scrollTo !== 'function') {
      link.scrollIntoView({ inline: 'center', block: 'nearest' });
    }
  }
}



function scrollTracker() {
  const currentYScroll = window.scrollY;
  let activeLink = null;
  let activeId = null;
  sections.forEach((section) => {
    const s = section;
    const sectionHeight = (s).offsetHeight;
    const sectionTop = (s).offsetTop - 300; // adjust for sticky nav
    const id = s.getAttribute("id");
    const currentNavLink = document.querySelector(`.food-link[href="#${id}"]`);
    if (
      currentYScroll > sectionTop &&
      currentYScroll <= sectionTop + sectionHeight
    ) {
      currentNavLink?.classList.add("active");
      activeLink = currentNavLink;
      activeId = id;
    } else {
      currentNavLink?.classList.remove("active");
    }
  });
  if (activeLink && activeId !== lastActiveId) {
    centerActiveLink(activeLink);
    lastActiveId = activeId;
  }
  ticking = false;
}

window.addEventListener("scroll", function() {
  if (!ticking) {
    window.requestAnimationFrame(scrollTracker);
    ticking = true;
  }
});


</script>